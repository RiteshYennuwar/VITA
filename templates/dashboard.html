{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}
{% block content %}

<div class="dashboard-container">
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="pdf-list">
            {% for pdf in user_pdfs %}
            <div class="pdf-item" data-pdf-id="{{ pdf._id }}">
                <span class="pdf-icon">üìÑ</span>
                <span class="pdf-name">{{ pdf.filename }}</span>
                <a href="{{ url_for('download', filename=pdf.name) }}" download>
                    <button class="download-btn">Download</button>
                </a>
            </div>
            {% endfor %}
        </div>
        
        <!-- Settings and Profile -->
        <div class="sidebar-bottom">
            <div class="sidebar-upload">
                <i class="sidebar-upload-icon">‚ûï</i>
                <a href="{{ url_for('upload') }}" class="sidebar-a">
                <span class="sidebar-upload-label">Upload PDF</span>
                </a>
            </div>
            <div class="settings">
                <i class="settings-icon">‚öôÔ∏è</i>
                <span class="settings-label">Settings</span>
            </div>
            <div class="profile">
                <i class="profile-icon">üë§</i>
                <a href="{{ url_for('profile') }}" class="sidebar-a">
                <span class="profile-label">Profile</span>
                </a>
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="main-content">
        <h1>Your Uploaded PDFs</h1>
        <p>Welcome, {{ user['first_name'] }} {{ user['last_name']}}! Select a PDF from the sidebar to start chatting.</p>
        <div id="pdf-info"></div>
        <!-- Add your main content here -->
    </div>

    <!-- Chatbot Button -->
    <button id="chatbot-toggle" class="chatbot-toggle">üí¨</button>

    <!-- Chatbot Container (Initially Hidden) -->
    <div class="chatbot-container hidden">
        <div class="chat-header">
            PDF Chatbot
            <button id="chatbot-close" class="chatbot-close">‚úñ</button>
        </div>
        <div id="chatbot-messages"></div>
        <div class="chat-input-container">
            <input type="text" id="chatbot-input" placeholder="Type a message...">
            <button id="chatbot-submit">‚û§</button>
        </div>
    </div>
</div>

<script>
    let selectedPdfId = null;
    let selectedPdfName = null;

    document.querySelectorAll('.pdf-item').forEach(item => {
        item.addEventListener('click', function() {
            selectedPdfId = this.getAttribute('data-pdf-id');
            selectedPdfName = this.querySelector('.pdf-name').textContent;
            document.getElementById('pdf-info').textContent = `Selected PDF: ${selectedPdfName}`;
            document.getElementById('chatbot-messages').innerHTML = ''; // Clear previous messages
            addMessage('Bot', `You've selected "${selectedPdfName}". How can I help you with this document?`);
        });
    });

    document.getElementById('chatbot-submit').addEventListener('click', sendMessage);
    document.getElementById('chatbot-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });

    function sendMessage() {
        const input = document.getElementById('chatbot-input');
        const message = input.value.trim();
        if (message && selectedPdfId) {
            addMessage('You', message);
            input.value = '';

            // Add loading message from bot
            const loadingMessageId = 'loading-message';
            addMessage('Bot', '<span id="' + loadingMessageId + '">...</span>');

            // Send the query to the server
            fetch('/query', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    query: message,
                    pdf_id: selectedPdfId
                }),
            })
            .then(response => response.json())
            .then(data => {
                // Remove loading message
                const loadingMessageElement = document.getElementById(loadingMessageId);
                if (loadingMessageElement) {
                    loadingMessageElement.parentElement.remove();
                }
                addMessage('Bot', data.answer);
            })
            .catch((error) => {
                console.error('Error:', error);
                // Remove loading message
                const loadingMessageElement = document.getElementById(loadingMessageId);
                if (loadingMessageElement) {
                    loadingMessageElement.parentElement.remove();
                }
                addMessage('Bot', 'Sorry, I encountered an error processing your request.');
            });
        } else if (!selectedPdfId) {
            addMessage('Bot', 'Please select a PDF from the sidebar before asking questions.');
        }
    }

    function addMessage(sender, message) {
        const messagesDiv = document.getElementById('chatbot-messages');
        const messageElement = document.createElement('div');
        messageElement.classList.add('message', sender === 'You' ? 'user-message' : 'bot-message');
        if (sender === 'Bot') {
            messageElement.innerHTML = message; // For rendering bot messages with HTML content
        } else {
            messageElement.textContent = message;
        }
        messagesDiv.appendChild(messageElement);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // Toggle Chatbot Visibility
    const chatbotContainer = document.querySelector('.chatbot-container');
    document.getElementById('chatbot-toggle').addEventListener('click', function() {
        chatbotContainer.classList.toggle('hidden');
    });

    // Close Chatbot
    document.getElementById('chatbot-close').addEventListener('click', function() {
        chatbotContainer.classList.add('hidden');
    });
</script>
{% endblock %}
